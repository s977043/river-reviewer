name: Link Check
on:
  pull_request:
  schedule:
    - cron: '0 2 * * 1'
jobs:
  lychee:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v6
      - name: Link Checker
        uses: lycheeverse/lychee-action@v2
        id: lychee
        continue-on-error: true
        with:
          args: --verbose --no-progress --exclude '^mailto:' --max-redirects 5 "./**/*.md"
          output: /tmp/lychee.md
          format: markdown
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create GitHub issue on failure (schedule only)
        if: github.event_name == 'schedule' && steps.lychee.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = '定期チェック: リンクチェック(lychee)が失敗しました';
            const labelName = 'scheduled-check';

            const openIssues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner,
                repo,
                state: 'open',
                labels: labelName,
                per_page: 100,
              },
            );
            if (openIssues.some(issue => issue.title === title)) {
              console.log('既存の Issue があるため新規作成をスキップします。');
              return;
            }

            const runUrl = `${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const reportPath = '/tmp/lychee.md';
            const report = fs.existsSync(reportPath) ? fs.readFileSync(reportPath, 'utf8') : '';
            const maxLines = 200;
            const reportLines = report.split('\n');
            const hasMoreLines = reportLines.length > maxLines;
            const snippet = reportLines.slice(0, maxLines).join('\n');
            const truncationNote = hasMoreLines
              ? '\n\n※ レポートは先頭 200 行のみを表示しています。残りの行は省略されています。'
              : '';
            const body = `定期実行でリンクチェックが失敗しています。\n\n- 実行: ${runUrl}\n- レポート先頭 ${maxLines} 行:\n\`\`\`\n${snippet}\n\`\`\`\n${truncationNote}\n`;

            let useLabelForIssue = true;
            try {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: labelName,
                color: 'f29513',
                description: '定期実行の自動検証で見つかった問題',
              });
            } catch (err) {
              if (err.status !== 422) {
                console.warn(`ラベル作成に失敗しましたが、処理を継続します: ${err.message}`);
                useLabelForIssue = false;
              }
            }

            try {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: useLabelForIssue ? [labelName] : [],
              });
              console.log(`Issue を作成しました: ${title}`);
            } catch (err) {
              console.error(`Issue 作成に失敗しました: ${err.message}`);
              throw err;
            }
      - name: Upload report
        uses: actions/upload-artifact@v6
        with:
          name: lychee-report
          path: /tmp/lychee.md
      - name: Fail if link check failed
        if: steps.lychee.outcome == 'failure'
        run: |
          echo "Lychee reported broken links. Download the 'lychee-report' artifact to see details."
          exit 1
