{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "River Reviewer Skill Schema",
  "type": "object",
  "required": ["id", "name", "description", "category"],
  "allOf": [
    {
      "anyOf": [
        { "required": ["phase"] },
        { "required": ["category"] },
        { "required": ["trigger"], "properties": { "trigger": { "$ref": "#/properties/trigger" } } }
      ]
    },
    {
      "anyOf": [
        { "required": ["applyTo"] },
        { "required": ["files"] },
        { "required": ["path_patterns"] },
        {
          "required": ["trigger"],
          "properties": { "trigger": { "$ref": "#/properties/trigger" } }
        }
      ]
    }
  ],
  "additionalProperties": false,
  "$defs": {
    "phase": {
      "type": "string",
      "enum": ["upstream", "midstream", "downstream"]
    },
    "streamCategory": {
      "type": "string",
      "enum": ["core", "upstream", "midstream", "downstream"]
    },
    "severity": {
      "type": "string",
      "enum": ["info", "minor", "major", "critical"]
    },
    "inputContext": {
      "type": "string",
      "enum": ["diff", "fullFile", "tests", "adr", "commitMessage", "repoConfig"]
    },
    "outputKind": {
      "type": "string",
      "enum": ["findings", "summary", "actions", "tests", "metrics", "questions"]
    },
    "modelHint": {
      "type": "string",
      "enum": ["cheap", "balanced", "high-accuracy"]
    },
    "dependency": {
      "anyOf": [
        {
          "type": "string",
          "enum": [
            "code_search",
            "test_runner",
            "adr_lookup",
            "repo_metadata",
            "coverage_report",
            "tracing"
          ]
        },
        {
          "type": "string",
          "pattern": "^custom:.+"
        }
      ]
    }
  },
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for the skill (recommended: rr-xxxx)",
      "minLength": 1
    },
    "name": {
      "type": "string",
      "description": "Human-readable skill name",
      "minLength": 1
    },
    "description": {
      "type": "string",
      "description": "Brief description of what the skill checks",
      "minLength": 1
    },
    "category": {
      "$ref": "#/$defs/streamCategory",
      "description": "Stream category (core/upstream/midstream/downstream)"
    },
    "phase": {
      "oneOf": [
        { "$ref": "#/$defs/phase" },
        {
          "type": "array",
          "items": { "$ref": "#/$defs/phase" },
          "minItems": 1
        }
      ],
      "description": "Which SDLC phase(s) this skill applies to"
    },
    "applyTo": {
      "type": "array",
      "description": "Glob patterns defining which files to check",
      "items": { "type": "string" },
      "minItems": 1
    },
    "files": {
      "type": "array",
      "description": "Alias for applyTo",
      "items": { "type": "string" },
      "minItems": 1
    },
    "path_patterns": {
      "type": "array",
      "description": "Alias for applyTo",
      "items": { "type": "string" },
      "minItems": 1
    },
    "tags": {
      "type": "array",
      "description": "Optional metadata for classification",
      "items": { "type": "string" },
      "uniqueItems": true
    },
    "severity": {
      "$ref": "#/$defs/severity",
      "description": "Optional severity rating"
    },
    "inputContext": {
      "type": "array",
      "description": "Input sources required for the skill to run",
      "items": { "$ref": "#/$defs/inputContext" },
      "minItems": 1,
      "uniqueItems": true
    },
    "outputKind": {
      "type": "array",
      "description": "Output categories produced by this skill",
      "items": { "$ref": "#/$defs/outputKind" },
      "minItems": 1,
      "uniqueItems": true,
      "default": ["findings"]
    },
    "modelHint": {
      "$ref": "#/$defs/modelHint",
      "description": "Hint for model selection (cost/accuracy balance)"
    },
    "dependencies": {
      "type": "array",
      "description": "Tools or resources this skill depends on",
      "items": { "$ref": "#/$defs/dependency" },
      "minItems": 1,
      "uniqueItems": true
    },
    "trigger": {
      "type": "object",
      "description": "Optional trigger container for activation criteria",
      "additionalProperties": false,
      "properties": {
        "phase": {
          "oneOf": [
            { "$ref": "#/$defs/phase" },
            {
              "type": "array",
              "items": { "$ref": "#/$defs/phase" },
              "minItems": 1
            }
          ]
        },
        "applyTo": {
          "type": "array",
          "description": "Glob patterns defining which files to check",
          "items": { "type": "string" },
          "minItems": 1
        },
        "path_patterns": {
          "type": "array",
          "description": "Alias for applyTo",
          "items": { "type": "string" },
          "minItems": 1
        },
        "files": {
          "type": "array",
          "description": "Alias for applyTo",
          "items": { "type": "string" },
          "minItems": 1
        }
      }
    },
    "instruction": {
      "type": "string",
      "description": "The prompt/instruction for the skill"
    },
    "metadata": {
      "type": "object",
      "description": "Optional nested metadata container",
      "additionalProperties": true
    },
    "version": {
      "type": "string",
      "description": "Semantic version (x.y.z)",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "prompt": {
      "type": "object",
      "description": "Prompt file references",
      "additionalProperties": false,
      "properties": {
        "system": {
          "type": "string",
          "description": "Path to system prompt file",
          "minLength": 1
        },
        "user": {
          "type": "string",
          "description": "Path to user prompt file",
          "minLength": 1
        }
      }
    },
    "eval": {
      "type": "object",
      "description": "Evaluation configuration",
      "additionalProperties": false,
      "properties": {
        "promptfoo": {
          "type": "string",
          "description": "Path to promptfoo configuration"
        }
      }
    },
    "fixturesDir": {
      "type": "string",
      "description": "Fixtures directory path",
      "default": "fixtures"
    },
    "goldenDir": {
      "type": "string",
      "description": "Golden directory path",
      "default": "golden"
    },
    "priority": {
      "type": "number",
      "description": "Optional ordering hint (lower runs earlier)"
    }
  }
}
